const translations = {
  es: {
    welcomeQuestion: '¬øC√≥mo te llamas?',
    usernamePlaceholder: 'Tu nombre de usuario',
    tmdbQuestion: '¬øCu√°l es tu clave API de TMDB?',
    tmdbPrivacy: 'Solo se usar√° para mostrarte informaci√≥n en tus b√∫squedas',
    tmdbKeyPlaceholder: 'API Key de TMDB',
    getTmdbKey: 'Consigue tu clave en:',
    startButton: 'Pasemos a crear tus listas',
    myLists: 'Mis Listas',
    createList: 'Crear Nueva Lista',
    listName: 'Nombre de la lista',
    listType: 'Tipo: movie, series...',
    create: 'Crear',
    searchTitle: 'Buscar y agregar contenido',
    searchPlaceholder: 'Buscar pel√≠culas/series...',
    selectList: 'Selecciona lista...',
    export: 'Exportar',
    import: 'Importar',
    copyUrl: 'Copiar URL',
    install: 'Instalar',
    rating: 'Puntuaci√≥n',
    share: 'Compartir',
    moveUp: 'Subir',
    moveDown: 'Bajar',
    delete: 'Eliminar'
  },
  en: {
    welcomeQuestion: "What's your name?",
    usernamePlaceholder: 'Your username',
    tmdbQuestion: 'What is your TMDB API Key?',
    tmdbPrivacy: 'It will only be used to show you search information',
    tmdbKeyPlaceholder: 'TMDB API Key',
    getTmdbKey: 'Get your key at:',
    startButton: "Let's create your lists",
    myLists: 'My Lists',
    createList: 'Create New List',
    listName: 'List name',
    listType: 'Type: movie, series...',
    create: 'Create',
    searchTitle: 'Search and add content',
    searchPlaceholder: 'Search movies/series...',
    selectList: 'Select list...',
    export: 'Export',
    import: 'Import',
    copyUrl: 'Copy URL',
    install: 'Install',
    rating: 'Rating',
    share: 'Share',
    moveUp: 'Move Up',
    moveDown: 'Move Down',
    delete: 'Delete'
  },
  fr: {
    welcomeQuestion: 'Comment tu t\'appelles ?',
    usernamePlaceholder: 'Ton nom d\'utilisateur',
    tmdbQuestion: 'Quelle est ta cl√© API TMDB ?',
    tmdbPrivacy: 'Elle sera utilis√©e uniquement pour afficher les informations de recherche',
    tmdbKeyPlaceholder: 'Cl√© API TMDB',
    getTmdbKey: 'Obtenez votre cl√© sur :',
    startButton: 'Cr√©ons tes listes',
    myLists: 'Mes Listes',
    createList: 'Cr√©er une Nouvelle Liste',
    listName: 'Nom de la liste',
    listType: 'Type : film, s√©rie...',
    create: 'Cr√©er',
    searchTitle: 'Rechercher et ajouter du contenu',
    searchPlaceholder: 'Rechercher films/s√©ries...',
    selectList: 'S√©lectionner une liste...',
    export: 'Exporter',
    import: 'Importer',
    copyUrl: 'Copier l\'URL',
    install: 'Installer',
    rating: 'Note',
    share: 'Partager',
    moveUp: 'Monter',
    moveDown: 'Descendre',
    delete: 'Supprimer'
  },
  de: {
    welcomeQuestion: 'Wie hei√üt du?',
    usernamePlaceholder: 'Dein Benutzername',
    tmdbQuestion: 'Was ist dein TMDB API-Schl√ºssel?',
    tmdbPrivacy: 'Er wird nur verwendet, um dir Suchinformationen anzuzeigen',
    tmdbKeyPlaceholder: 'TMDB API-Schl√ºssel',
    getTmdbKey: 'Hol dir deinen Schl√ºssel unter:',
    startButton: 'Lass uns deine Listen erstellen',
    myLists: 'Meine Listen',
    createList: 'Neue Liste erstellen',
    listName: 'Listenname',
    listType: 'Typ: Film, Serie...',
    create: 'Erstellen',
    searchTitle: 'Suchen und hinzuf√ºgen',
    searchPlaceholder: 'Filme/Serien suchen...',
    selectList: 'Liste ausw√§hlen...',
    export: 'Exportieren',
    import: 'Importieren',
    copyUrl: 'URL kopieren',
    install: 'Installieren',
    rating: 'Bewertung',
    share: 'Teilen',
    moveUp: 'Nach oben',
    moveDown: 'Nach unten',
    delete: 'L√∂schen'
  },
  it: {
    welcomeQuestion: 'Come ti chiami?',
    usernamePlaceholder: 'Il tuo nome utente',
    tmdbQuestion: 'Qual √® la tua chiave API TMDB?',
    tmdbPrivacy: 'Verr√† utilizzata solo per mostrarti informazioni di ricerca',
    tmdbKeyPlaceholder: 'Chiave API TMDB',
    getTmdbKey: 'Ottieni la tua chiave su:',
    startButton: 'Creiamo le tue liste',
    myLists: 'Le Mie Liste',
    createList: 'Crea Nuova Lista',
    listName: 'Nome della lista',
    listType: 'Tipo: film, serie...',
    create: 'Crea',
    searchTitle: 'Cerca e aggiungi contenuti',
    searchPlaceholder: 'Cerca film/serie...',
    selectList: 'Seleziona lista...',
    export: 'Esporta',
    import: 'Importa',
    copyUrl: 'Copia URL',
    install: 'Installa',
    rating: 'Valutazione',
    share: 'Condividi',
    moveUp: 'Su',
    moveDown: 'Gi√π',
    delete: 'Elimina'
  },
  pt: {
    welcomeQuestion: 'Qual √© o seu nome?',
    usernamePlaceholder: 'Seu nome de usu√°rio',
    tmdbQuestion: 'Qual √© a sua chave API TMDB?',
    tmdbPrivacy: 'Ser√° usada apenas para mostrar informa√ß√µes de pesquisa',
    tmdbKeyPlaceholder: 'Chave API TMDB',
    getTmdbKey: 'Obtenha sua chave em:',
    startButton: 'Vamos criar suas listas',
    myLists: 'Minhas Listas',
    createList: 'Criar Nova Lista',
    listName: 'Nome da lista',
    listType: 'Tipo: filme, s√©rie...',
    create: 'Criar',
    searchTitle: 'Pesquisar e adicionar conte√∫do',
    searchPlaceholder: 'Pesquisar filmes/s√©ries...',
    selectList: 'Selecione a lista...',
    export: 'Exportar',
    import: 'Importar',
    copyUrl: 'Copiar URL',
    install: 'Instalar',
    rating: 'Avalia√ß√£o',
    share: 'Compartilhar',
    moveUp: 'Subir',
    moveDown: 'Descer',
    delete: 'Excluir'
  },
  ru: {
    welcomeQuestion: '–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?',
    usernamePlaceholder: '–¢–≤–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
    tmdbQuestion: '–ö–∞–∫–æ–π —É —Ç–µ–±—è API –∫–ª—é—á TMDB?',
    tmdbPrivacy: '–û–Ω –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ–∏—Å–∫–∞',
    tmdbKeyPlaceholder: 'API –∫–ª—é—á TMDB',
    getTmdbKey: '–ü–æ–ª—É—á–∏ —Å–≤–æ–π –∫–ª—é—á –Ω–∞:',
    startButton: '–î–∞–≤–∞–π —Å–æ–∑–¥–∞–¥–∏–º —Ç–≤–æ–∏ —Å–ø–∏—Å–∫–∏',
    myLists: '–ú–æ–∏ –°–ø–∏—Å–∫–∏',
    createList: '–°–æ–∑–¥–∞—Ç—å –ù–æ–≤—ã–π –°–ø–∏—Å–æ–∫',
    listName: '–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞',
    listType: '–¢–∏–ø: —Ñ–∏–ª—å–º, —Å–µ—Ä–∏–∞–ª...',
    create: '–°–æ–∑–¥–∞—Ç—å',
    searchTitle: '–ü–æ–∏—Å–∫ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞',
    searchPlaceholder: '–ò—Å–∫–∞—Ç—å —Ñ–∏–ª—å–º—ã/—Å–µ—Ä–∏–∞–ª—ã...',
    selectList: '–í—ã–±—Ä–∞—Ç—å —Å–ø–∏—Å–æ–∫...',
    export: '–≠–∫—Å–ø–æ—Ä—Ç',
    import: '–ò–º–ø–æ—Ä—Ç',
    copyUrl: '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å URL',
    install: '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å',
    rating: '–†–µ–π—Ç–∏–Ω–≥',
    share: '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è',
    moveUp: '–í–≤–µ—Ä—Ö',
    moveDown: '–í–Ω–∏–∑',
    delete: '–£–¥–∞–ª–∏—Ç—å'
  },
  ja: {
    welcomeQuestion: '„ÅäÂêçÂâç„ÅØÔºü',
    usernamePlaceholder: '„É¶„Éº„Ç∂„ÉºÂêç',
    tmdbQuestion: 'TMDB API„Ç≠„Éº„ÅØÔºü',
    tmdbPrivacy: 'Ê§úÁ¥¢ÊÉÖÂ†±„ÅÆË°®Á§∫„Å´„ÅÆ„Åø‰ΩøÁî®„Åï„Çå„Åæ„Åô',
    tmdbKeyPlaceholder: 'TMDB API„Ç≠„Éº',
    getTmdbKey: '„Ç≠„Éº„ÅÆÂèñÂæó„ÅØ„Åì„Å°„Çâ:',
    startButton: '„É™„Çπ„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åó„Çá„ÅÜ',
    myLists: '„Éû„Ç§„É™„Çπ„Éà',
    createList: 'Êñ∞„Åó„ÅÑ„É™„Çπ„Éà„Çí‰ΩúÊàê',
    listName: '„É™„Çπ„ÉàÂêç',
    listType: '„Çø„Ç§„ÉóÔºöÊò†Áîª„ÄÅ„Ç∑„É™„Éº„Ç∫...',
    create: '‰ΩúÊàê',
    searchTitle: '„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÊ§úÁ¥¢„Åó„Å¶ËøΩÂä†',
    searchPlaceholder: 'Êò†Áîª/„Ç∑„É™„Éº„Ç∫„ÇíÊ§úÁ¥¢...',
    selectList: '„É™„Çπ„Éà„ÇíÈÅ∏Êäû...',
    export: '„Ç®„ÇØ„Çπ„Éù„Éº„Éà',
    import: '„Ç§„É≥„Éù„Éº„Éà',
    copyUrl: 'URL„Çí„Ç≥„Éî„Éº',
    install: '„Ç§„É≥„Çπ„Éà„Éº„É´',
    rating: 'Ë©ï‰æ°',
    share: 'ÂÖ±Êúâ',
    moveUp: '‰∏ä„Å∏',
    moveDown: '‰∏ã„Å∏',
    delete: 'ÂâäÈô§'
  },
  zh: {
    welcomeQuestion: '‰Ω†Âè´‰ªÄ‰πàÂêçÂ≠óÔºü',
    usernamePlaceholder: '‰Ω†ÁöÑÁî®Êà∑Âêç',
    tmdbQuestion: '‰Ω†ÁöÑTMDB APIÂØÜÈí•ÊòØ‰ªÄ‰πàÔºü',
    tmdbPrivacy: '‰ªÖÁî®‰∫éÊòæÁ§∫ÊêúÁ¥¢‰ø°ÊÅØ',
    tmdbKeyPlaceholder: 'TMDB APIÂØÜÈí•',
    getTmdbKey: 'Ëé∑ÂèñÂØÜÈí•Ôºö',
    startButton: 'ËÆ©Êàë‰ª¨ÂàõÂª∫‰Ω†ÁöÑÂàóË°®',
    myLists: 'ÊàëÁöÑÂàóË°®',
    createList: 'ÂàõÂª∫Êñ∞ÂàóË°®',
    listName: 'ÂàóË°®ÂêçÁß∞',
    listType: 'Á±ªÂûãÔºöÁîµÂΩ±ÔºåÁ≥ªÂàó...',
    create: 'ÂàõÂª∫',
    searchTitle: 'ÊêúÁ¥¢Âπ∂Ê∑ªÂä†ÂÜÖÂÆπ',
    searchPlaceholder: 'ÊêúÁ¥¢ÁîµÂΩ±/Á≥ªÂàó...',
    selectList: 'ÈÄâÊã©ÂàóË°®...',
    export: 'ÂØºÂá∫',
    import: 'ÂØºÂÖ•',
    copyUrl: 'Â§çÂà∂URL',
    install: 'ÂÆâË£Ö',
    rating: 'ËØÑÂàÜ',
    share: 'ÂàÜ‰∫´',
    moveUp: '‰∏äÁßª',
    moveDown: '‰∏ãÁßª',
    delete: 'Âà†Èô§'
  }
};

let currentLang = 'es';
let currentUsername = '';
let currentTmdbKey = '';

const welcomeUsername = document.getElementById('welcomeUsername');
const welcomeTmdbKey = document.getElementById('welcomeTmdbKey');
const startBtn = document.getElementById('startBtn');

function checkWelcomeForm() {
  const hasUsername = welcomeUsername.value.trim().length > 0;
  const hasTmdbKey = welcomeTmdbKey.value.trim().length > 0;
  startBtn.disabled = !(hasUsername && hasTmdbKey);
}

welcomeUsername.addEventListener('input', checkWelcomeForm);
welcomeTmdbKey.addEventListener('input', checkWelcomeForm);

startBtn.addEventListener('click', () => {
  currentUsername = welcomeUsername.value.trim();
  currentTmdbKey = welcomeTmdbKey.value.trim();
  
  localStorage.setItem('username', currentUsername);
  localStorage.setItem('tmdbKey', currentTmdbKey);
  
  document.getElementById('displayUsername').textContent = currentUsername;
  document.getElementById('welcomeScreen').classList.remove('active');
  document.getElementById('mainScreen').classList.add('active');
  
  loadLists(currentUsername);
});

document.getElementById('langSelect').addEventListener('change', (e) => {
  currentLang = e.target.value;
  document.getElementById('langSelectMain').value = currentLang;
  updateUI();
});

document.getElementById('langSelectMain').addEventListener('change', (e) => {
  currentLang = e.target.value;
  document.getElementById('langSelect').value = currentLang;
  updateUI();
});

function updateUI() {
  const t = translations[currentLang] || translations.es;
  
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (t[key]) el.textContent = t[key];
  });
  
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.getAttribute('data-i18n-placeholder');
    if (t[key]) el.placeholder = t[key];
  });

  const targetList = document.getElementById('targetList');
  if (targetList.options.length > 0) {
    targetList.options[0].text = t.selectList;
  }
}

document.getElementById('newListForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = document.getElementById('listName').value.trim();
  const type = document.getElementById('listType').value.trim();
  
  if (!name || !type) return;
  
  const res = await fetch('/api/lists', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: currentUsername, list: { name, type } })
  });
  
  if (res.ok) {
    loadLists(currentUsername);
    e.target.reset();
  }
});

async function getOptimalId(tmdbId, mediaType) {
  try {
    if (!currentTmdbKey) return `tmdb:${tmdbId}`;
    
    const url = `https://api.themoviedb.org/3/${mediaType === 'tv' ? 'tv' : 'movie'}/${tmdbId}/external_ids?api_key=${currentTmdbKey}`;
    const res = await fetch(url);
    const data = await res.json();
    
    return data.imdb_id || `tmdb:${tmdbId}`;
  } catch (e) {
    return `tmdb:${tmdbId}`;
  }
}

async function addToList(tmdbId, mediaType, title, poster, overview, rating) {
  const listId = document.getElementById('targetList').value;
  if (!listId) return alert('Selecciona una lista primero');

  const optimalId = await getOptimalId(tmdbId, mediaType);

  await fetch(`/api/lists/${listId}/items`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ 
      username: currentUsername, 
      item: { tmdbId, imdbId: optimalId, mediaType, title, poster, overview, rating } 
    })
  });
  
  alert('¬°A√±adido correctamente!');
  loadLists(currentUsername);
}

async function loadLists(username) {
  const res = await fetch(`/api/lists?username=${username}`);
  const lists = await res.json();
  
  const t = translations[currentLang] || translations.es;
  const display = document.getElementById('listDisplay');
  display.innerHTML = lists.length === 0 
    ? '<p style="text-align:center; opacity:0.7;">No hay listas creadas a√∫n</p>'
    : lists.map((list, idx) => `
    <div class="list-item">
      <div class="list-info">
        <strong>${list.name}</strong> <span style="opacity:0.8">(${list.type})</span><br>
        <small>${list.items?.length || 0} elementos</small>
      </div>
      <div class="list-actions">
        <button onclick="shareList('${list.id}', '${list.name}')" data-tooltip="${t.share}">üë§</button>
        <button onclick="moveList('${list.id}', ${idx}, -1)" ${idx === 0 ? 'disabled' : ''} data-tooltip="${t.moveUp}">‚ñ≤</button>
        <button onclick="moveList('${list.id}', ${idx}, 1)" ${idx === lists.length - 1 ? 'disabled' : ''} data-tooltip="${t.moveDown}">‚ñº</button>
        <button onclick="deleteList('${list.id}')" data-tooltip="${t.delete}">üóëÔ∏è</button>
      </div>
    </div>
  `).join('');
  
  const targetList = document.getElementById('targetList');
  targetList.innerHTML = 
    `<option value="">${t.selectList}</option>` +
    lists.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
}

async function shareList(id, name) {
  const url = `${window.location.origin}/manifest.json?username=${currentUsername}`;
  if (navigator.share) {
    await navigator.share({ title: name, text: `${currentUsername} te recomienda ${name}`, url });
  } else {
    navigator.clipboard.writeText(url);
    alert('¬°URL copiada!');
  }
}

async function deleteList(id) {
  if (!confirm('¬øEliminar esta lista?')) return;
  await fetch(`/api/lists/${id}?username=${currentUsername}`, { method: 'DELETE' });
  loadLists(currentUsername);
}

async function moveList(id, currentIndex, direction) {
  const newOrder = currentIndex + direction;
  await fetch(`/api/lists/${id}/reorder`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: currentUsername, newOrder })
  });
  loadLists(currentUsername);
}

// ‚úÖ IMPORTAR LISTAS
document.getElementById('importBtn').addEventListener('click', () => {
  document.getElementById('importFile').click();
});

document.getElementById('importFile').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = async (event) => {
    try {
      const data = JSON.parse(event.target.result);
      const res = await fetch('/api/lists/import', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: currentUsername, lists: data.lists })
      });
      
      if (res.ok) {
        alert('¬°Listas importadas correctamente!');
        loadLists(currentUsername);
      }
    } catch (err) {
      alert('Error al importar archivo');
    }
  };
  reader.readAsText(file);
  e.target.value = '';
});

document.getElementById('exportBtn').addEventListener('click', async () => {
  const res = await fetch(`/api/lists?username=${currentUsername}`);
  const lists = await res.json();
  const blob = new Blob([JSON.stringify({ username: currentUsername, lists }, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `customlibrary-${currentUsername}.json`;
  a.click();
});

document.getElementById('copyInstallBtn').addEventListener('click', () => {
  const url = `${window.location.origin}/manifest.json?username=${currentUsername}`;
  navigator.clipboard.writeText(url);
  alert('¬°URL copiada!');
});

document.getElementById('installBtn').addEventListener('click', () => {
  const url = `stremio://${window.location.host}/manifest.json?username=${currentUsername}`;
  window.open(url, '_blank');
});

let searchTimeout;
document.getElementById('searchInput').addEventListener('input', (e) => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(async () => {
    const q = e.target.value.trim();
    if (q.length < 3 || !currentTmdbKey) return;
    
    const langMap = { es: 'es-ES', en: 'en-US', fr: 'fr-FR', de: 'de-DE', it: 'it-IT', pt: 'pt-PT', ru: 'ru-RU', ja: 'ja-JP', zh: 'zh-CN' };
    const res = await fetch(`/api/tmdb/search?q=${q}&key=${currentTmdbKey}&lang=${langMap[currentLang] || 'en-US'}`);
    const data = await res.json();
    
    const t = translations[currentLang] || translations.es;
    document.getElementById('searchResults').innerHTML = (data.results || []).slice(0, 12).map(item => {
      const title = item.title || item.name;
      const mediaType = item.media_type || 'movie';
      const overview = item.overview || 'No hay sinopsis disponible';
      const rating = item.vote_average ? `‚≠ê ${item.vote_average.toFixed(1)}` : '';
      
      return `
        <div class="search-item" onclick='addToList(${item.id}, "${mediaType}", "${title.replace(/'/g, "\\'")}", "${item.poster_path || ''}", "${overview.replace(/'/g, "\\'")}", "${rating}")'>
          <img src="https://image.tmdb.org/t/p/w200${item.poster_path || ''}" alt="${title}" onerror="this.src='image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'80\' height=\'120\'%3E%3Crect fill=\'%23333\' width=\'80\' height=\'120\'/%3E%3C/svg%3E'">
          <div class="search-item-info">
            <strong>${title}</strong>
            <small>${mediaType.toUpperCase()}</small>
            ${rating ? `<div class="rating">${rating}</div>` : ''}
            <div class="overview">${overview}</div>
          </div>
        </div>
      `;
    }).join('');
  }, 600);
});

window.addEventListener('DOMContentLoaded', () => {
  const savedUsername = localStorage.getItem('username');
  const savedKey = localStorage.getItem('tmdbKey');
  
  if (savedUsername && savedKey) {
    currentUsername = savedUsername;
    currentTmdbKey = savedKey;
    document.getElementById('displayUsername').textContent = currentUsername;
    document.getElementById('welcomeScreen').classList.remove('active');
    document.getElementById('mainScreen').classList.add('active');
    loadLists(currentUsername);
  }
  
  updateUI();
});
