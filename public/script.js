const translations = {
  en: {
    languageQuestionFirst: 'Hey, what language can we speak?',
    welcomeQuestion: 'Welcome, what can I call you?',
    yourName: 'Your name',
    continue: 'Continue',
    welcomeBack: 'Welcome back!',
    enterPin: 'Enter your 4-digit PIN',
    login: 'Login',
    newUser: 'New user!',
    addonNameQuestion: 'And what should I be called?',
    addonNameHelp: 'This will be the addon name in your player',
    tmdbQuestion: "I'll need your TMDB API Key",
    tmdbKeyPlaceholder: 'TMDB API Key',
    getTmdbKeyText: 'Get it',
    here: 'HERE',
    createPin: 'Create a 4-digit PIN',
    pinHelp: 'Use it to access your account',
    startButton: "Let's create your lists",
    mainTitleTemplate: 'Alright {{username}}, what did you like?',
    yourLists: 'These are your lists',
    createList: 'Create new list',
    listName: 'List name',
    listTypeTemplate: "{{username}}'s library",
    create: 'Create',
    searchPlaceholder: 'Search movies/series...',
    importPin: 'Add list by PIN',
    copyUrl: 'Copy install URL',
    install: 'Install in your player',
    share: 'Share',
    delete: 'Delete',
    selectListModal: 'Which list do you want to add this to?',
    add: 'Add',
    cancel: 'Cancel',
    back: 'Back',
    importPinTitle: 'Enter the 6-digit PIN',
    import: 'Import',
    sharePinTitle: 'List PIN',
    sharePinText: 'Share this PIN so others can import the list',
    copyPin: 'Copy PIN',
    close: 'Close',
    deleteItem: 'Delete',
    rate: 'Rate',
    rateTitle: 'Rate this item',
    reviewPlaceholder: 'Write a review (optional)...',
    submit: 'Submit',
    ratingsTitle: 'Ratings',
    viewRatings: 'Ratings',
    friends: 'Friends',
    friendUsername: 'Username',
    addFriend: 'Add friend',
    removeFriend: 'Remove',
    friendLists: 'Lists',
    friendRatings: 'Recent ratings',
    noFriends: 'No friends yet',
    noLists: 'No lists created yet',
    noItems: 'No items in this list'
  },
  es: {
    languageQuestionFirst: 'Ey, ¿en qué idioma podemos hablar?',
    welcomeQuestion: 'Bienvenido, ¿cómo puedo llamarte?',
    yourName: 'Tu nombre',
    continue: 'Continuar',
    welcomeBack: '¡Bienvenido de nuevo!',
    enterPin: 'Introduce tu PIN de 4 dígitos',
    login: 'Iniciar sesión',
    newUser: '¡Nuevo usuario!',
    addonNameQuestion: '¿Y cómo me llamo yo?',
    addonNameHelp: 'Este será el nombre del addon en tu reproductor',
    tmdbQuestion: 'Voy a necesitar tu clave API de TMDB',
    tmdbKeyPlaceholder: 'API Key de TMDB',
    getTmdbKeyText: 'Esto lo consigues',
    here: 'AQUÍ',
    createPin: 'Crea un PIN de 4 dígitos',
    pinHelp: 'Úsalo para acceder a tu cuenta',
    startButton: 'Pasemos a crear tus listas',
    mainTitleTemplate: 'De acuerdo {{username}}, ¿qué fue eso que te gustó?',
    yourLists: 'Estas son tus listas',
    createList: 'Crear nueva lista',
    listName: 'Nombre de la lista',
    listTypeTemplate: 'Librería de {{username}}',
    create: 'Crear',
    searchPlaceholder: 'Buscar películas/series...',
    importPin: 'Añadir lista por PIN',
    copyUrl: 'Copiar URL de instalación',
    install: 'Instalar en tu reproductor',
    share: 'Compartir',
    delete: 'Eliminar',
    selectListModal: '¿A qué lista quieres agregar esto?',
    add: 'Agregar',
    cancel: 'Cancelar',
    back: 'Volver',
    importPinTitle: 'Introduce el PIN de 6 dígitos',
    import: 'Importar',
    sharePinTitle: 'PIN de la lista',
    sharePinText: 'Comparte este PIN para que otros puedan importar la lista',
    copyPin: 'Copiar PIN',
    close: 'Cerrar',
    deleteItem: 'Eliminar',
    rate: 'Calificar',
    rateTitle: 'Calificar este elemento',
    reviewPlaceholder: 'Escribe una reseña (opcional)...',
    submit: 'Enviar',
    ratingsTitle: 'Calificaciones',
    viewRatings: 'Calificaciones',
    friends: 'Amigos',
    friendUsername: 'Nombre de usuario',
    addFriend: 'Añadir amigo',
    removeFriend: 'Eliminar',
    friendLists: 'Listas',
    friendRatings: 'Calificaciones recientes',
    noFriends: 'Aún no tienes amigos',
    noLists: 'No hay listas creadas aún',
    noItems: 'No hay elementos en esta lista'
  },
  fr: {
    languageQuestionFirst: 'Hé, quelle langue pouvons-nous parler?',
    welcomeQuestion: 'Bienvenue, comment puis-je t\'appeler?',
    yourName: 'Ton nom',
    continue: 'Continuer',
    welcomeBack: 'Bon retour!',
    enterPin: 'Entre ton PIN à 4 chiffres',
    login: 'Connexion',
    newUser: 'Nouvel utilisateur!',
    addonNameQuestion: 'Et comment je m\'appelle?',
    addonNameHelp: 'Ce sera le nom de l\'addon dans ton lecteur',
    tmdbQuestion: 'J\'aurai besoin de ta clé API TMDB',
    tmdbKeyPlaceholder: 'Clé API TMDB',
    getTmdbKeyText: 'Obtiens-la',
    here: 'ICI',
    createPin: 'Crée un PIN à 4 chiffres',
    pinHelp: 'Utilise-le pour accéder à ton compte',
    startButton: 'Créons tes listes',
    mainTitleTemplate: "D'accord {{username}}, qu'as-tu aimé?",
    yourLists: 'Voici tes listes',
    createList: 'Créer une nouvelle liste',
    listName: 'Nom de la liste',
    listTypeTemplate: 'Bibliothèque de {{username}}',
    create: 'Créer',
    searchPlaceholder: 'Rechercher films/séries...',
    importPin: 'Ajouter une liste par PIN',
    copyUrl: 'Copier l\'URL d\'installation',
    install: 'Installer dans ton lecteur',
    share: 'Partager',
    delete: 'Supprimer',
    selectListModal: 'À quelle liste veux-tu ajouter ceci?',
    add: 'Ajouter',
    cancel: 'Annuler',
    back: 'Retour',
    importPinTitle: 'Entre le PIN à 6 chiffres',
    import: 'Importer',
    sharePinTitle: 'PIN de la liste',
    sharePinText: 'Partage ce PIN pour que d\'autres puissent importer la liste',
    copyPin: 'Copier le PIN',
    close: 'Fermer',
    deleteItem: 'Supprimer',
    rate: 'Noter',
    rateTitle: 'Noter cet élément',
    reviewPlaceholder: 'Écris un avis (optionnel)...',
    submit: 'Envoyer',
    ratingsTitle: 'Notes',
    viewRatings: 'Notes',
    friends: 'Amis',
    friendUsername: 'Nom d\'utilisateur',
    addFriend: 'Ajouter un ami',
    removeFriend: 'Supprimer',
    friendLists: 'Listes',
    friendRatings: 'Notes récentes',
    noFriends: 'Pas encore d\'amis',
    noLists: 'Aucune liste créée',
    noItems: 'Aucun élément dans cette liste'
  },
  de: {
    languageQuestionFirst: 'Hey, welche Sprache können wir sprechen?',
    welcomeQuestion: 'Willkommen, wie kann ich dich nennen?',
    yourName: 'Dein Name',
    continue: 'Weiter',
    welcomeBack: 'Willkommen zurück!',
    enterPin: 'Gib deine 4-stellige PIN ein',
    login: 'Anmelden',
    newUser: 'Neuer Benutzer!',
    addonNameQuestion: 'Und wie soll ich heißen?',
    addonNameHelp: 'Dies wird der Addon-Name in deinem Player sein',
    tmdbQuestion: 'Ich brauche deinen TMDB API-Schlüssel',
    tmdbKeyPlaceholder: 'TMDB API-Schlüssel',
    getTmdbKeyText: 'Hol ihn dir',
    here: 'HIER',
    createPin: 'Erstelle eine 4-stellige PIN',
    pinHelp: 'Verwende sie für den Zugriff auf dein Konto',
    startButton: 'Lass uns deine Listen erstellen',
    mainTitleTemplate: 'Ok {{username}}, was hat dir gefallen?',
    yourLists: 'Das sind deine Listen',
    createList: 'Neue Liste erstellen',
    listName: 'Listenname',
    listTypeTemplate: '{{username}}s Bibliothek',
    create: 'Erstellen',
    searchPlaceholder: 'Filme/Serien suchen...',
    importPin: 'Liste per PIN hinzufügen',
    copyUrl: 'Installations-URL kopieren',
    install: 'In deinem Player installieren',
    share: 'Teilen',
    delete: 'Löschen',
    selectListModal: 'Zu welcher Liste möchtest du dies hinzufügen?',
    add: 'Hinzufügen',
    cancel: 'Abbrechen',
    back: 'Zurück',
    importPinTitle: 'Gib die 6-stellige PIN ein',
    import: 'Importieren',
    sharePinTitle: 'Listen-PIN',
    sharePinText: 'Teile diese PIN, damit andere die Liste importieren können',
    copyPin: 'PIN kopieren',
    close: 'Schließen',
    deleteItem: 'Löschen',
    rate: 'Bewerten',
    rateTitle: 'Dieses Element bewerten',
    reviewPlaceholder: 'Schreibe eine Bewertung (optional)...',
    submit: 'Senden',
    ratingsTitle: 'Bewertungen',
    viewRatings: 'Bewertungen',
    friends: 'Freunde',
    friendUsername: 'Benutzername',
    addFriend: 'Freund hinzufügen',
    removeFriend: 'Entfernen',
    friendLists: 'Listen',
    friendRatings: 'Aktuelle Bewertungen',
    noFriends: 'Noch keine Freunde',
    noLists: 'Noch keine Listen erstellt',
    noItems: 'Keine Elemente in dieser Liste'
  },
  it: {
    languageQuestionFirst: 'Ehi, che lingua possiamo parlare?',
    welcomeQuestion: 'Benvenuto, come posso chiamarti?',
    yourName: 'Il tuo nome',
    continue: 'Continua',
    welcomeBack: 'Bentornato!',
    enterPin: 'Inserisci il tuo PIN a 4 cifre',
    login: 'Accedi',
    newUser: 'Nuovo utente!',
    addonNameQuestion: 'E come mi chiamo io?',
    addonNameHelp: 'Questo sarà il nome dell\'addon nel tuo lettore',
    tmdbQuestion: 'Avrò bisogno della tua chiave API TMDB',
    tmdbKeyPlaceholder: 'Chiave API TMDB',
    getTmdbKeyText: 'Ottienila',
    here: 'QUI',
    createPin: 'Crea un PIN a 4 cifre',
    pinHelp: 'Usalo per accedere al tuo account',
    startButton: 'Creiamo le tue liste',
    mainTitleTemplate: 'Va bene {{username}}, cosa ti è piaciuto?',
    yourLists: 'Queste sono le tue liste',
    createList: 'Crea nuova lista',
    listName: 'Nome della lista',
    listTypeTemplate: 'Biblioteca di {{username}}',
    create: 'Crea',
    searchPlaceholder: 'Cerca film/serie...',
    importPin: 'Aggiungi lista con PIN',
    copyUrl: 'Copia URL di installazione',
    install: 'Installa nel tuo lettore',
    share: 'Condividi',
    delete: 'Elimina',
    selectListModal: 'A quale lista vuoi aggiungere questo?',
    add: 'Aggiungi',
    cancel: 'Annulla',
    back: 'Indietro',
    importPinTitle: 'Inserisci il PIN a 6 cifre',
    import: 'Importa',
    sharePinTitle: 'PIN della lista',
    sharePinText: 'Condividi questo PIN affinché altri possano importare la lista',
    copyPin: 'Copia PIN',
    close: 'Chiudi',
    deleteItem: 'Elimina',
    rate: 'Vota',
    rateTitle: 'Vota questo elemento',
    reviewPlaceholder: 'Scrivi una recensione (opzionale)...',
    submit: 'Invia',
    ratingsTitle: 'Valutazioni',
    viewRatings: 'Valutazioni',
    friends: 'Amici',
    friendUsername: 'Nome utente',
    addFriend: 'Aggiungi amico',
    removeFriend: 'Rimuovi',
    friendLists: 'Liste',
    friendRatings: 'Valutazioni recenti',
    noFriends: 'Nessun amico ancora',
    noLists: 'Nessuna lista creata',
    noItems: 'Nessun elemento in questa lista'
  },
  pt: {
    languageQuestionFirst: 'Ei, que idioma podemos falar?',
    welcomeQuestion: 'Bem-vindo, como posso te chamar?',
    yourName: 'Seu nome',
    continue: 'Continuar',
    welcomeBack: 'Bem-vindo de volta!',
    enterPin: 'Digite seu PIN de 4 dígitos',
    login: 'Entrar',
    newUser: 'Novo usuário!',
    addonNameQuestion: 'E como eu me chamo?',
    addonNameHelp: 'Este será o nome do addon no seu player',
    tmdbQuestion: 'Vou precisar da sua chave API TMDB',
    tmdbKeyPlaceholder: 'Chave API TMDB',
    getTmdbKeyText: 'Consiga',
    here: 'AQUI',
    createPin: 'Crie um PIN de 4 dígitos',
    pinHelp: 'Use-o para acessar sua conta',
    startButton: 'Vamos criar suas listas',
    mainTitleTemplate: 'Certo {{username}}, do que você gostou?',
    yourLists: 'Estas são suas listas',
    createList: 'Criar nova lista',
    listName: 'Nome da lista',
    listTypeTemplate: 'Biblioteca de {{username}}',
    create: 'Criar',
    searchPlaceholder: 'Pesquisar filmes/séries...',
    importPin: 'Adicionar lista por PIN',
    copyUrl: 'Copiar URL de instalação',
    install: 'Instalar no seu player',
    share: 'Compartilhar',
    delete: 'Excluir',
    selectListModal: 'A qual lista você quer adicionar isto?',
    add: 'Adicionar',
    cancel: 'Cancelar',
    back: 'Voltar',
    importPinTitle: 'Digite o PIN de 6 dígitos',
    import: 'Importar',
    sharePinTitle: 'PIN da lista',
    sharePinText: 'Compartilhe este PIN para que outros possam importar a lista',
    copyPin: 'Copiar PIN',
    close: 'Fechar',
    deleteItem: 'Excluir',
    rate: 'Avaliar',
    rateTitle: 'Avaliar este item',
    reviewPlaceholder: 'Escreva uma avaliação (opcional)...',
    submit: 'Enviar',
    ratingsTitle: 'Avaliações',
    viewRatings: 'Avaliações',
    friends: 'Amigos',
    friendUsername: 'Nome de usuário',
    addFriend: 'Adicionar amigo',
    removeFriend: 'Remover',
    friendLists: 'Listas',
    friendRatings: 'Avaliações recentes',
    noFriends: 'Ainda sem amigos',
    noLists: 'Nenhuma lista criada',
    noItems: 'Nenhum item nesta lista'
  },
  ru: {
    languageQuestionFirst: 'Эй, на каком языке мы можем говорить?',
    welcomeQuestion: 'Добро пожаловать, как мне тебя называть?',
    yourName: 'Твое имя',
    continue: 'Продолжить',
    welcomeBack: 'С возвращением!',
    enterPin: 'Введи свой 4-значный PIN',
    login: 'Войти',
    newUser: 'Новый пользователь!',
    addonNameQuestion: 'А как меня зовут?',
    addonNameHelp: 'Это будет имя аддона в твоем плеере',
    tmdbQuestion: 'Мне понадобится твой API ключ TMDB',
    tmdbKeyPlaceholder: 'API ключ TMDB',
    getTmdbKeyText: 'Получи его',
    here: 'ЗДЕСЬ',
    createPin: 'Создай 4-значный PIN',
    pinHelp: 'Используй его для доступа к аккаунту',
    startButton: 'Давай создадим твои списки',
    mainTitleTemplate: 'Хорошо {{username}}, что тебе понравилось?',
    yourLists: 'Вот твои списки',
    createList: 'Создать новый список',
    listName: 'Название списка',
    listTypeTemplate: 'Библиотека {{username}}',
    create: 'Создать',
    searchPlaceholder: 'Искать фильмы/сериалы...',
    importPin: 'Добавить список по PIN',
    copyUrl: 'Копировать URL установки',
    install: 'Установить в твой плеер',
    share: 'Поделиться',
    delete: 'Удалить',
    selectListModal: 'В какой список добавить это?',
    add: 'Добавить',
    cancel: 'Отменить',
    back: 'Назад',
    importPinTitle: 'Введите 6-значный PIN',
    import: 'Импортировать',
    sharePinTitle: 'PIN списка',
    sharePinText: 'Поделитесь этим PIN, чтобы другие могли импортировать список',
    copyPin: 'Копировать PIN',
    close: 'Закрыть',
    deleteItem: 'Удалить',
    rate: 'Оценить',
    rateTitle: 'Оценить этот элемент',
    reviewPlaceholder: 'Напишите отзыв (необязательно)...',
    submit: 'Отправить',
    ratingsTitle: 'Оценки',
    viewRatings: 'Оценки',
    friends: 'Друзья',
    friendUsername: 'Имя пользователя',
    addFriend: 'Добавить друга',
    removeFriend: 'Удалить',
    friendLists: 'Списки',
    friendRatings: 'Недавние оценки',
    noFriends: 'Пока нет друзей',
    noLists: 'Списков еще не создано',
    noItems: 'В этом списке нет элементов'
  },
  ja: {
    languageQuestionFirst: 'やあ、何語で話せますか？',
    welcomeQuestion: 'ようこそ、何と呼べばいいですか？',
    yourName: 'あなたの名前',
    continue: '続ける',
    welcomeBack: 'おかえりなさい！',
    enterPin: '4桁のPINを入力',
    login: 'ログイン',
    newUser: '新しいユーザー！',
    addonNameQuestion: '私の名前は？',
    addonNameHelp: 'これがあなたのプレーヤーのアドオン名になります',
    tmdbQuestion: 'TMDB APIキーが必要です',
    tmdbKeyPlaceholder: 'TMDB APIキー',
    getTmdbKeyText: 'こちらで取得',
    here: 'ここ',
    createPin: '4桁のPINを作成',
    pinHelp: 'アカウントにアクセスするために使用',
    startButton: 'リストを作成しましょう',
    mainTitleTemplate: 'わかりました{{username}}さん、何が好きでしたか？',
    yourLists: 'あなたのリスト',
    createList: '新しいリストを作成',
    listName: 'リスト名',
    listTypeTemplate: '{{username}}のライブラリ',
    create: '作成',
    searchPlaceholder: '映画/シリーズを検索...',
    importPin: 'PINでリストを追加',
    copyUrl: 'インストールURLをコピー',
    install: 'プレーヤーにインストール',
    share: '共有',
    delete: '削除',
    selectListModal: 'どのリストに追加しますか？',
    add: '追加',
    cancel: 'キャンセル',
    back: '戻る',
    importPinTitle: '6桁のPINを入力',
    import: 'インポート',
    sharePinTitle: 'リストのPIN',
    sharePinText: 'このPINを共有して他の人がリストをインポートできるようにします',
    copyPin: 'PINをコピー',
    close: '閉じる',
    deleteItem: '削除',
    rate: '評価',
    rateTitle: 'このアイテムを評価',
    reviewPlaceholder: 'レビューを書く（オプション）...',
    submit: '送信',
    ratingsTitle: '評価',
    viewRatings: '評価',
    friends: '友達',
    friendUsername: 'ユーザー名',
    addFriend: '友達を追加',
    removeFriend: '削除',
    friendLists: 'リスト',
    friendRatings: '最近の評価',
    noFriends: 'まだ友達がいません',
    noLists: 'リストがまだ作成されていません',
    noItems: 'このリストにアイテムがありません'
  },
  zh: {
    languageQuestionFirst: '嘿，我们可以说什么语言？',
    welcomeQuestion: '欢迎，我该怎么称呼你？',
    yourName: '你的名字',
    continue: '继续',
    welcomeBack: '欢迎回来！',
    enterPin: '输入你的4位PIN',
    login: '登录',
    newUser: '新用户！',
    addonNameQuestion: '我叫什么名字？',
    addonNameHelp: '这将是你播放器中的插件名称',
    tmdbQuestion: '我需要你的TMDB API密钥',
    tmdbKeyPlaceholder: 'TMDB API密钥',
    getTmdbKeyText: '在这里获取',
    here: '这里',
    createPin: '创建4位PIN',
    pinHelp: '用它访问你的账户',
    startButton: '让我们创建你的列表',
    mainTitleTemplate: '好的{{username}}，你喜欢什么？',
    yourLists: '这些是你的列表',
    createList: '创建新列表',
    listName: '列表名称',
    listTypeTemplate: '{{username}}的图书馆',
    create: '创建',
    searchPlaceholder: '搜索电影/系列...',
    importPin: '通过PIN添加列表',
    copyUrl: '复制安装URL',
    install: '安装到播放器',
    share: '分享',
    delete: '删除',
    selectListModal: '你想添加到哪个列表？',
    add: '添加',
    cancel: '取消',
    back: '返回',
    importPinTitle: '输入6位PIN',
    import: '导入',
    sharePinTitle: '列表PIN',
    sharePinText: '分享此PIN以便其他人导入列表',
    copyPin: '复制PIN',
    close: '关闭',
    deleteItem: '删除',
    rate: '评分',
    rateTitle: '为此项目评分',
    reviewPlaceholder: '写评论（可选）...',
    submit: '提交',
    ratingsTitle: '评分',
    viewRatings: '评分',
    friends: '朋友',
    friendUsername: '用户名',
    addFriend: '添加朋友',
    removeFriend: '删除',
    friendLists: '列表',
    friendRatings: '最近的评分',
    noFriends: '还没有朋友',
    noLists: '还没有创建列表',
    noItems: '此列表中没有项目'
  }
};

let currentLang = 'en';
let currentUsername = '';
let currentTmdbKey = '';
let currentAddonName = '';
let pendingItem = null;
let currentListId = null;
let currentItemId = null;
let selectedRating = 0;
let tempUsername = '';

const welcomeUsername = document.getElementById('welcomeUsername');
const checkUserBtn = document.getElementById('checkUserBtn');
const langSelect = document.getElementById('langSelect');
const loginPin = document.getElementById('loginPin');
const loginBtn = document.getElementById('loginBtn');
const backToUsernameBtn = document.getElementById('backToUsernameBtn');
const addonNameInput = document.getElementById('addonName');
const registerTmdbKey = document.getElementById('registerTmdbKey');
const registerPin = document.getElementById('registerPin');
const registerBtn = document.getElementById('registerBtn');

function updateAddonName() {
  const t = translations[currentLang] || translations.en;
  const username = tempUsername || welcomeUsername.value.trim();
  if (username) {
    addonNameInput.value = t.listTypeTemplate.replace('{{username}}', username);
  }
}

function updateListTypePlaceholder() {
  const t = translations[currentLang] || translations.en;
  document.getElementById('listType').value = t.listTypeTemplate.replace('{{username}}', currentUsername);
}

langSelect.addEventListener('change', (e) => {
  currentLang = e.target.value;
  updateUI();
  updateAddonName();
});

welcomeUsername.addEventListener('input', () => {
  checkUserBtn.disabled = welcomeUsername.value.trim().length === 0;
});

checkUserBtn.addEventListener('click', async () => {
  tempUsername = welcomeUsername.value.trim();
  if (!tempUsername) return;
  
  const res = await fetch('/api/auth/check-user', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: tempUsername })
  });
  
  const data = await res.json();
  
  if (data.exists) {
    currentLang = data.user.language || 'en';
    langSelect.value = currentLang;
    updateUI();
    
    document.getElementById('welcomeScreen').classList.remove('active');
    document.getElementById('loginScreen').classList.add('active');
    document.getElementById('welcomeBackText').textContent = `${translations[currentLang].welcomeBack} ${tempUsername}!`;
  } else {
    updateAddonName();
    document.getElementById('welcomeScreen').classList.remove('active');
    document.getElementById('registerScreen').classList.add('active');
  }
});

backToUsernameBtn.addEventListener('click', () => {
  document.getElementById('loginScreen').classList.remove('active');
  document.getElementById('welcomeScreen').classList.add('active');
  loginPin.value = '';
  tempUsername = '';
});

loginPin.addEventListener('input', () => {
  loginBtn.disabled = loginPin.value.length !== 4;
});

loginBtn.addEventListener('click', async () => {
  const pin = loginPin.value.trim();
  if (pin.length !== 4) return;
  
  const res = await fetch('/api/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: tempUsername, pin })
  });
  
  const data = await res.json();
  
  if (data.success) {
    currentUsername = tempUsername;
    currentTmdbKey = data.user.tmdb_key;
    currentAddonName = data.user.addon_name;
    currentLang = data.user.language || 'en';
    
    localStorage.setItem('username', currentUsername);
    localStorage.setItem('pin', pin);
    
    const t = translations[currentLang] || translations.en;
    document.getElementById('mainTitle').textContent = t.mainTitleTemplate.replace('{{username}}', currentUsername);
    
    document.getElementById('loginScreen').classList.remove('active');
    document.getElementById('mainScreen').classList.add('active');
    
    loadLists(currentUsername);
    loadFriends(currentUsername);
    updateListTypePlaceholder();
    updateUI();
  } else {
    alert(data.error || 'PIN incorrecto');
    loginPin.value = '';
  }
});

registerPin.addEventListener('input', () => {
  const hasAddonName = addonNameInput.value.trim().length > 0;
  const hasTmdbKey = registerTmdbKey.value.trim().length > 0;
  const hasPin = registerPin.value.length === 4;
  registerBtn.disabled = !(hasAddonName && hasTmdbKey && hasPin);
});

registerTmdbKey.addEventListener('input', () => {
  const hasAddonName = addonNameInput.value.trim().length > 0;
  const hasTmdbKey = registerTmdbKey.value.trim().length > 0;
  const hasPin = registerPin.value.length === 4;
  registerBtn.disabled = !(hasAddonName && hasTmdbKey && hasPin);
});

addonNameInput.addEventListener('input', () => {
  const hasAddonName = addonNameInput.value.trim().length > 0;
  const hasTmdbKey = registerTmdbKey.value.trim().length > 0;
  const hasPin = registerPin.value.length === 4;
  registerBtn.disabled = !(hasAddonName && hasTmdbKey && hasPin);
});

registerBtn.addEventListener('click', async () => {
  const addonName = addonNameInput.value.trim();
  const tmdbKey = registerTmdbKey.value.trim();
  const pin = registerPin.value.trim();
  
  if (!addonName || !tmdbKey || pin.length !== 4) return;
  
  const res = await fetch('/api/auth/register', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ 
      username: tempUsername, 
      pin, 
      addonName, 
      tmdbKey,
      language: currentLang
    })
  });
  
  const data = await res.json();
  
  if (data.success) {
    currentUsername = tempUsername;
    currentTmdbKey = tmdbKey;
    currentAddonName = addonName;
    
    localStorage.setItem('username', currentUsername);
    localStorage.setItem('pin', pin);
    
    const t = translations[currentLang] || translations.en;
    document.getElementById('mainTitle').textContent = t.mainTitleTemplate.replace('{{username}}', currentUsername);
    
    document.getElementById('registerScreen').classList.remove('active');
    document.getElementById('mainScreen').classList.add('active');
    
    loadLists(currentUsername);
    loadFriends(currentUsername);
    updateListTypePlaceholder();
  } else {
    alert(data.error || 'Error al registrar');
  }
});

document.getElementById('changeUserBtn').addEventListener('click', () => {
  if (!confirm('¿Cerrar sesión?')) return;
  
  localStorage.removeItem('username');
  localStorage.removeItem('pin');
  
  currentUsername = '';
  currentTmdbKey = '';
  currentAddonName = '';
  tempUsername = '';
  
  welcomeUsername.value = '';
  loginPin.value = '';
  registerPin.value = '';
  registerTmdbKey.value = '';
  
  document.getElementById('mainScreen').classList.remove('active');
  document.getElementById('welcomeScreen').classList.add('active');
});

function updateUI() {
  const t = translations[currentLang] || translations.en;
  
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (t[key]) {
      if (key === 'mainTitleTemplate') {
        el.textContent = t[key].replace('{{username}}', currentUsername);
      } else {
        el.textContent = t[key];
      }
    }
  });
  
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.getAttribute('data-i18n-placeholder');
    if (t[key]) el.placeholder = t[key];
  });
}

document.getElementById('newListForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = document.getElementById('listName').value.trim();
  const type = document.getElementById('listType').value.trim();
  
  if (!name || !type) return;
  
  const res = await fetch('/api/lists', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: currentUsername, list: { name, type } })
  });
  
  if (res.ok) {
    loadLists(currentUsername);
    e.target.reset();
    updateListTypePlaceholder();
  }
});

async function getOptimalId(tmdbId, mediaType) {
  try {
    if (!currentTmdbKey) return `tmdb:${tmdbId}`;
    
    const url = `https://api.themoviedb.org/3/${mediaType === 'tv' ? 'tv' : 'movie'}/${tmdbId}/external_ids?api_key=${currentTmdbKey}`;
    const res = await fetch(url);
    const data = await res.json();
    
    return data.imdb_id || `tmdb:${tmdbId}`;
  } catch (e) {
    return `tmdb:${tmdbId}`;
  }
}

function showListModal(item) {
  pendingItem = item;
  const modal = document.getElementById('listModal');
  modal.classList.add('active');
}

document.getElementById('modalCancelBtn').addEventListener('click', () => {
  document.getElementById('listModal').classList.remove('active');
  pendingItem = null;
});

document.getElementById('modalAddBtn').addEventListener('click', async () => {
  const listId = document.getElementById('modalListSelect').value;
  if (!listId || !pendingItem) return;

  const optimalId = await getOptimalId(pendingItem.tmdbId, pendingItem.mediaType);

  await fetch(`/api/lists/${listId}/items`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ 
      username: currentUsername, 
      item: { 
        tmdbId: pendingItem.tmdbId, 
        imdbId: optimalId, 
        mediaType: pendingItem.mediaType, 
        title: pendingItem.title, 
        poster: pendingItem.poster, 
        overview: pendingItem.overview, 
        rating: pendingItem.rating 
      } 
    })
  });
  
  alert('¡Añadido correctamente!');
  document.getElementById('listModal').classList.remove('active');
  pendingItem = null;
  loadLists(currentUsername);
});

async function loadLists(username) {
  const res = await fetch(`/api/lists?username=${username}`);
  const lists = await res.json();
  
  const t = translations[currentLang] || translations.en;
  const display = document.getElementById('listDisplay');
  display.innerHTML = lists.length === 0 
    ? `<p style="text-align:center; opacity:0.7;">${t.noLists}</p>`
    : lists.map((list, idx) => `
    <div class="list-item" draggable="true" data-id="${list.id}" data-index="${idx}">
      <div class="list-info" onclick="showListDetail('${list.id}')">
        <strong>${escapeHtml(list.name)}</strong> <span style="opacity:0.8">(${escapeHtml(list.type)})</span><br>
        <small>${list.items?.length || 0} elementos</small>
      </div>
      <div class="list-actions">
        <button onclick="shareList('${list.id}', '${escapeHtml(list.name)}', '${list.pin}')">${t.share}</button>
        <button onclick="deleteList('${list.id}')" ${!list.isOwner ? 'disabled style="opacity:0.3"' : ''}>${t.delete}</button>
        <div class="arrows">
          <button onclick="moveList('${list.id}', ${idx}, -1)" ${idx === 0 ? 'disabled' : ''}>▲</button>
          <button onclick="moveList('${list.id}', ${idx}, 1)" ${idx === lists.length - 1 ? 'disabled' : ''}>▼</button>
        </div>
      </div>
    </div>
  `).join('');
  
  document.querySelectorAll('.list-item').forEach(item => {
    item.addEventListener('dragstart', handleDragStart);
    item.addEventListener('dragover', handleDragOver);
    item.addEventListener('drop', handleDrop);
    item.addEventListener('dragend', handleDragEnd);
  });
  
  const modalListSelect = document.getElementById('modalListSelect');
  modalListSelect.innerHTML = lists.map(l => `<option value="${l.id}">${escapeHtml(l.name)}</option>`).join('');
}

async function loadFriends(username) {
  const res = await fetch(`/api/friends?username=${username}`);
  const friends = await res.json();
  
  const t = translations[currentLang] || translations.en;
  const display = document.getElementById('friendsDisplay');
  
  if (friends.length === 0) {
    display.innerHTML = `<p style="text-align:center; opacity:0.7;">${t.noFriends}</p>`;
  } else {
    display.innerHTML = friends.map(f => `
      <div class="friend-item">
        <div class="friend-info" onclick="showFriendDetail('${escapeHtml(f.friend_username)}')">
          <strong>${escapeHtml(f.friend_username)}</strong>
        </div>
        <button onclick="removeFriend('${escapeHtml(f.friend_username)}')">${t.removeFriend}</button>
      </div>
    `).join('');
  }
}

document.getElementById('addFriendForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const friendUsername = document.getElementById('friendUsername').value.trim();
  
  if (!friendUsername || friendUsername === currentUsername) {
    alert('Usuario inválido');
    return;
  }
  
  const res = await fetch('/api/friends/add', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: currentUsername, friendUsername })
  });
  
  if (res.ok) {
    loadFriends(currentUsername);
    e.target.reset();
  } else {
    const data = await res.json();
    alert(data.error || 'Error al añadir amigo');
  }
});

async function removeFriend(friendUsername) {
  if (!confirm(`¿Eliminar a ${friendUsername}?`)) return;
  
  await fetch(`/api/friends/${friendUsername}?username=${currentUsername}`, { method: 'DELETE' });
  loadFriends(currentUsername);
}

async function showFriendDetail(friendUsername) {
  document.getElementById('friendDetailTitle').textContent = friendUsername;
  
  const listsRes = await fetch(`/api/lists?username=${friendUsername}`);
  const lists = await listsRes.json();
  
  const t = translations[currentLang] || translations.en;
  const listsDisplay = document.getElementById('friendListsDisplay');
  
  listsDisplay.innerHTML = lists.length === 0
    ? `<p style="opacity:0.7;">${t.noLists}</p>`
    : lists.map(list => `
      <div class="list-item">
        <div class="list-info">
          <strong>${escapeHtml(list.name)}</strong> <span style="opacity:0.8">(${escapeHtml(list.type)})</span><br>
          <small>${list.items?.length || 0} elementos</small>
        </div>
      </div>
    `).join('');
  
  document.getElementById('friendRatingsDisplay').innerHTML = '<p style="opacity:0.7;">Próximamente...</p>';
  
  document.getElementById('mainScreen').classList.remove('active');
  document.getElementById('friendDetailScreen').classList.add('active');
}

document.getElementById('backFromFriendBtn').addEventListener('click', () => {
  document.getElementById('friendDetailScreen').classList.remove('active');
  document.getElementById('mainScreen').classList.add('active');
});

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

let draggedElement = null;

function handleDragStart(e) {
  draggedElement = this;
  this.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}

function handleDragOver(e) {
  if (e.preventDefault) e.preventDefault();
  this.classList.add('drag-over');
  e.dataTransfer.dropEffect = 'move';
  return false;
}

function handleDrop(e) {
  if (e.stopPropagation) e.stopPropagation();
  
  if (draggedElement !== this) {
    const fromIndex = parseInt(draggedElement.dataset.index);
    const toIndex = parseInt(this.dataset.index);
    
    moveList(draggedElement.dataset.id, fromIndex, toIndex - fromIndex);
  }
  
  return false;
}

function handleDragEnd() {
  document.querySelectorAll('.list-item').forEach(item => {
    item.classList.remove('dragging', 'drag-over');
  });
}

async function shareList(id, name, pin) {
  document.getElementById('pinDisplay').textContent = pin;
  document.getElementById('showPinModal').classList.add('active');
}

document.getElementById('copyPinBtn').addEventListener('click', () => {
  const pin = document.getElementById('pinDisplay').textContent;
  navigator.clipboard.writeText(pin);
  alert('¡PIN copiado!');
});

document.getElementById('closePinBtn').addEventListener('click', () => {
  document.getElementById('showPinModal').classList.remove('active');
});

async function deleteList(id) {
  if (!confirm('¿Eliminar esta lista?')) return;
  await fetch(`/api/lists/${id}?username=${currentUsername}`, { method: 'DELETE' });
  loadLists(currentUsername);
}

async function moveList(id, currentIndex, direction) {
  const newOrder = currentIndex + direction;
  await fetch(`/api/lists/${id}/reorder`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: currentUsername, newOrder })
  });
  loadLists(currentUsername);
}

document.getElementById('importBtn').addEventListener('click', () => {
  document.getElementById('pinModal').classList.add('active');
});

document.getElementById('pinCancelBtn').addEventListener('click', () => {
  document.getElementById('pinModal').classList.remove('active');
  document.getElementById('pinInput').value = '';
});

document.getElementById('pinImportBtn').addEventListener('click', async () => {
  const pin = document.getElementById('pinInput').value.trim();
  if (pin.length !== 6) {
    alert('El PIN debe tener 6 dígitos');
    return;
  }
  
  const res = await fetch('/api/lists/import-pin', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: currentUsername, pin })
  });
  
  if (res.ok) {
    alert('¡Lista importada correctamente!');
    document.getElementById('pinModal').classList.remove('active');
    document.getElementById('pinInput').value = '';
    loadLists(currentUsername);
  } else {
    const data = await res.json();
    alert(data.error || 'PIN no válido');
  }
});

document.getElementById('copyInstallBtn').addEventListener('click', () => {
  const url = `${window.location.origin}/manifest.json?username=${currentUsername}&addonName=${encodeURIComponent(currentAddonName)}`;
  navigator.clipboard.writeText(url);
  alert('¡URL copiada!');
});

document.getElementById('installBtn').addEventListener('click', () => {
  const url = `stremio://${window.location.host}/manifest.json?username=${currentUsername}&addonName=${encodeURIComponent(currentAddonName)}`;
  window.open(url, '_blank');
});

async function showListDetail(listId) {
  currentListId = listId;
  const res = await fetch(`/api/lists/${listId}?username=${currentUsername}`);
  const list = await res.json();
  
  document.getElementById('listDetailTitle').textContent = list.name;
  
  const t = translations[currentLang] || translations.en;
  const itemsContainer = document.getElementById('listDetailItems');
  itemsContainer.innerHTML = list.items.length === 0
    ? `<p style="text-align:center; opacity:0.7;">${t.noItems}</p>`
    : list.items.map(item => `
      <div class="detail-item">
        <div class="detail-item-content">
          <img src="${item.poster ? `https://image.tmdb.org/t/p/w200${item.poster}` : 'image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'80\' height=\'120\'%3E%3Crect fill=\'%23333\' width=\'80\' height=\'120\'/%3E%3C/svg%3E'}" alt="${escapeHtml(item.title)}">
          <div class="detail-item-info">
            <div class="detail-item-title">
              <strong>${escapeHtml(item.title)}</strong>
              ${item.rating ? `<span class="rating">${escapeHtml(item.rating)}</span>` : ''}
            </div>
            <div class="overview">${escapeHtml(item.overview) || 'Sin sinopsis'}</div>
          </div>
        </div>
        <div class="detail-item-actions">
          <button onclick="openRatingModal('${item.id}')">${t.rate}</button>
          <button onclick="viewRatings('${item.id}')">${item.avgRating ? '⭐ ' + item.avgRating : t.viewRatings}</button>
          ${list.isOwner ? `<button class="delete-btn" onclick="deleteItem('${listId}', '${item.id}')">${t.deleteItem}</button>` : ''}
        </div>
      </div>
    `).join('');
  
  document.getElementById('mainScreen').classList.remove('active');
  document.getElementById('listDetailScreen').classList.add('active');
}

document.getElementById('backBtn').addEventListener('click', () => {
  document.getElementById('listDetailScreen').classList.remove('active');
  document.getElementById('mainScreen').classList.add('active');
  loadLists(currentUsername);
});

async function deleteItem(listId, itemId) {
  if (!confirm('¿Eliminar este elemento?')) return;
  
  await fetch(`/api/lists/${listId}/items/${itemId}?username=${currentUsername}`, { method: 'DELETE' });
  showListDetail(listId);
}

function openRatingModal(itemId) {
  currentItemId = itemId;
  selectedRating = 0;
  document.querySelectorAll('.star').forEach(star => star.classList.remove('active'));
  document.getElementById('reviewText').value = '';
  document.getElementById('ratingModal').classList.add('active');
}

document.querySelectorAll('.star').forEach(star => {
  star.addEventListener('click', function() {
    selectedRating = parseInt(this.dataset.rating);
    document.querySelectorAll('.star').forEach((s, idx) => {
      if (idx < selectedRating) {
        s.classList.add('active');
      } else {
        s.classList.remove('active');
      }
    });
  });
});

document.getElementById('submitRatingBtn').addEventListener('click', async () => {
  if (selectedRating === 0) {
    alert('Por favor selecciona una calificación');
    return;
  }
  
  const review = document.getElementById('reviewText').value.trim();
  
  await fetch(`/api/items/${currentItemId}/rate`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: currentUsername, stars: selectedRating, review })
  });
  
  alert('¡Calificación guardada!');
  document.getElementById('ratingModal').classList.remove('active');
  showListDetail(currentListId);
});

document.getElementById('cancelRatingBtn').addEventListener('click', () => {
  document.getElementById('ratingModal').classList.remove('active');
});

async function viewRatings(itemId) {
  const res = await fetch(`/api/items/${itemId}/ratings`);
  const ratings = await res.json();
  
  const t = translations[currentLang] || translations.en;
  const display = document.getElementById('ratingsDisplay');
  
  if (ratings.length === 0) {
    display.innerHTML = '<p style="text-align:center; opacity:0.7;">No hay calificaciones aún</p>';
  } else {
    display.innerHTML = ratings.map(r => `
      <div class="rating-item">
        <div class="rating-item-header">
          <span class="rating-item-user">${escapeHtml(r.username)}</span>
          <span class="rating-item-stars">${'★'.repeat(r.stars)}${'☆'.repeat(5 - r.stars)}</span>
        </div>
        ${r.review ? `<div class="rating-item-review">${escapeHtml(r.review)}</div>` : ''}
      </div>
    `).join('');
  }
  
  document.getElementById('viewRatingsModal').classList.add('active');
}

document.getElementById('closeRatingsBtn').addEventListener('click', () => {
  document.getElementById('viewRatingsModal').classList.remove('active');
});

let searchTimeout;
document.getElementById('searchInput').addEventListener('input', (e) => {
  clearTimeout(searchTimeout);
  const q = e.target.value.trim();
  
  if (q.length === 0) {
    document.getElementById('searchResults').innerHTML = '';
    return;
  }
  
  if (q.length < 3 || !currentTmdbKey) return;
  
  searchTimeout = setTimeout(async () => {
    const langMap = { es: 'es-ES', en: 'en-US', fr: 'fr-FR', de: 'de-DE', it: 'it-IT', pt: 'pt-PT', ru: 'ru-RU', ja: 'ja-JP', zh: 'zh-CN' };
    const res = await fetch(`/api/tmdb/search?q=${encodeURIComponent(q)}&key=${currentTmdbKey}&lang=${langMap[currentLang] || 'en-US'}`);
    const data = await res.json();
    
    const results = (data.results || [])
      .filter(item => item.media_type === 'movie' || item.media_type === 'tv')
      .sort((a, b) => (b.vote_count || 0) - (a.vote_count || 0))
      .slice(0, 12);
    
    document.getElementById('searchResults').innerHTML = results
      .map(item => {
        const title = item.title || item.name;
        const mediaType = item.media_type;
        const overview = item.overview || 'No hay sinopsis disponible';
        const rating = item.vote_average ? `⭐ ${item.vote_average.toFixed(1)}` : '';
        const poster = item.poster_path || '';
        
        const itemData = {
          tmdbId: item.id,
          mediaType: mediaType,
          title: title,
          poster: poster,
          overview: overview,
          rating: rating
        };
        
        const itemDataStr = JSON.stringify(itemData).replace(/"/g, '&quot;');
        
        return `
          <div class="search-item" onclick='showListModal(${itemDataStr})'>
            <img src="https://image.tmdb.org/t/p/w200${poster}" alt="${escapeHtml(title)}" onerror="this.src='image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'80\\' height=\\'120\\'%3E%3Crect fill=\\'%23333\\' width=\\'80\\' height=\\'120\\'/%3E%3C/svg%3E'">
            <div class="search-item-info">
              <strong>${escapeHtml(title)}</strong>
              <small>${mediaType.toUpperCase()}</small>
              ${rating ? `<div class="rating">${rating}</div>` : ''}
              <div class="overview">${escapeHtml(overview)}</div>
            </div>
          </div>
        `;
      }).join('');
  }, 600);
});

window.addEventListener('DOMContentLoaded', () => {
  const savedUsername = localStorage.getItem('username');
  const savedPin = localStorage.getItem('pin');
  
  if (savedUsername && savedPin) {
    fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: savedUsername, pin: savedPin })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        currentUsername = savedUsername;
        currentTmdbKey = data.user.tmdb_key;
        currentAddonName = data.user.addon_name;
        currentLang = data.user.language || 'en';
        langSelect.value = currentLang;
        
        const t = translations[currentLang] || translations.en;
        document.getElementById('mainTitle').textContent = t.mainTitleTemplate.replace('{{username}}', currentUsername);
        
        document.getElementById('welcomeScreen').classList.remove('active');
        document.getElementById('mainScreen').classList.add('active');
        
        loadLists(currentUsername);
        loadFriends(currentUsername);
        updateListTypePlaceholder();
        updateUI();
      }
    });
  }
  
  updateUI();
});
