const translations = {
  es: {
    helloQuestion: 'Hola, ¿cómo te llamas?',
    yourName: 'Tu nombre',
    addonNameQuestion: '¿Y cómo me llamo yo?',
    addonNameHelp: 'Este será el nombre del addon en Stremio',
    languageQuestion: '¿En qué idioma hablas?',
    tmdbQuestion: 'Voy a necesitar tu clave API de TMDB',
    tmdbKeyPlaceholder: 'API Key de TMDB',
    getTmdbKeyText: 'Esto lo consigues',
    here: 'AQUÍ',
    startButton: 'Pasemos a crear tus listas',
    mainTitleTemplate: 'De acuerdo {{username}}, ¿qué fue eso que te gustó?',
    yourLists: 'Estas son tus listas',
    createList: 'Crear Nueva Lista',
    listName: 'Nombre de la lista',
    listType: 'Tipo: movie, series...',
    create: 'Crear',
    searchPlaceholder: 'Buscar películas/series...',
    export: 'Exportar Listas',
    import: 'Importar Listas',
    copyUrl: 'Copiar URL de Instalación',
    install: 'Instalar en Stremio',
    share: 'Compartir',
    delete: 'Eliminar',
    selectListModal: '¿A qué lista quieres agregar esto?',
    add: 'Agregar',
    cancel: 'Cancelar',
    shareTemplate: '{{username}} te recomienda esta lista "{{listName}}"'
  },
  en: {
    helloQuestion: "Hello, what's your name?",
    yourName: 'Your name',
    addonNameQuestion: 'And what should I be called?',
    addonNameHelp: 'This will be the addon name in Stremio',
    languageQuestion: 'What language do you speak?',
    tmdbQuestion: "I'll need your TMDB API Key",
    tmdbKeyPlaceholder: 'TMDB API Key',
    getTmdbKeyText: 'Get it',
    here: 'HERE',
    startButton: "Let's create your lists",
    mainTitleTemplate: 'Alright {{username}}, what did you like?',
    yourLists: 'These are your lists',
    createList: 'Create New List',
    listName: 'List name',
    listType: 'Type: movie, series...',
    create: 'Create',
    searchPlaceholder: 'Search movies/series...',
    export: 'Export Lists',
    import: 'Import Lists',
    copyUrl: 'Copy Install URL',
    install: 'Install in Stremio',
    share: 'Share',
    delete: 'Delete',
    selectListModal: 'Which list do you want to add this to?',
    add: 'Add',
    cancel: 'Cancel',
    shareTemplate: '{{username}} recommends this list "{{listName}}"'
  },
  fr: {
    helloQuestion: 'Bonjour, comment tu t\'appelles ?',
    yourName: 'Ton nom',
    addonNameQuestion: 'Et comment je m\'appelle ?',
    addonNameHelp: 'Ce sera le nom de l\'addon dans Stremio',
    languageQuestion: 'Quelle langue parles-tu ?',
    tmdbQuestion: 'J\'aurai besoin de ta clé API TMDB',
    tmdbKeyPlaceholder: 'Clé API TMDB',
    getTmdbKeyText: 'Obtiens-la',
    here: 'ICI',
    startButton: 'Créons tes listes',
    mainTitleTemplate: "D'accord {{username}}, qu'est-ce que tu as aimé ?",
    yourLists: 'Voici tes listes',
    createList: 'Créer une Nouvelle Liste',
    listName: 'Nom de la liste',
    listType: 'Type : film, série...',
    create: 'Créer',
    searchPlaceholder: 'Rechercher films/séries...',
    export: 'Exporter les Listes',
    import: 'Importer des Listes',
    copyUrl: 'Copier l\'URL d\'Installation',
    install: 'Installer dans Stremio',
    share: 'Partager',
    delete: 'Supprimer',
    selectListModal: 'À quelle liste veux-tu ajouter ceci ?',
    add: 'Ajouter',
    cancel: 'Annuler',
    shareTemplate: '{{username}} te recommande cette liste "{{listName}}"'
  },
  de: {
    helloQuestion: 'Hallo, wie heißt du?',
    yourName: 'Dein Name',
    addonNameQuestion: 'Und wie soll ich heißen?',
    addonNameHelp: 'Dies wird der Addon-Name in Stremio sein',
    languageQuestion: 'Welche Sprache sprichst du?',
    tmdbQuestion: 'Ich brauche deinen TMDB API-Schlüssel',
    tmdbKeyPlaceholder: 'TMDB API-Schlüssel',
    getTmdbKeyText: 'Hol ihn dir',
    here: 'HIER',
    startButton: 'Lass uns deine Listen erstellen',
    mainTitleTemplate: 'Ok {{username}}, was hat dir gefallen?',
    yourLists: 'Das sind deine Listen',
    createList: 'Neue Liste erstellen',
    listName: 'Listenname',
    listType: 'Typ: Film, Serie...',
    create: 'Erstellen',
    searchPlaceholder: 'Filme/Serien suchen...',
    export: 'Listen exportieren',
    import: 'Listen importieren',
    copyUrl: 'Installations-URL kopieren',
    install: 'In Stremio installieren',
    share: 'Teilen',
    delete: 'Löschen',
    selectListModal: 'Zu welcher Liste möchtest du dies hinzufügen?',
    add: 'Hinzufügen',
    cancel: 'Abbrechen',
    shareTemplate: '{{username}} empfiehlt dir diese Liste "{{listName}}"'
  },
  it: {
    helloQuestion: 'Ciao, come ti chiami?',
    yourName: 'Il tuo nome',
    addonNameQuestion: 'E come mi chiamo io?',
    addonNameHelp: 'Questo sarà il nome dell\'addon in Stremio',
    languageQuestion: 'Che lingua parli?',
    tmdbQuestion: 'Avrò bisogno della tua chiave API TMDB',
    tmdbKeyPlaceholder: 'Chiave API TMDB',
    getTmdbKeyText: 'Ottienila',
    here: 'QUI',
    startButton: 'Creiamo le tue liste',
    mainTitleTemplate: 'Va bene {{username}}, cosa ti è piaciuto?',
    yourLists: 'Queste sono le tue liste',
    createList: 'Crea Nuova Lista',
    listName: 'Nome della lista',
    listType: 'Tipo: film, serie...',
    create: 'Crea',
    searchPlaceholder: 'Cerca film/serie...',
    export: 'Esporta Liste',
    import: 'Importa Liste',
    copyUrl: 'Copia URL di Installazione',
    install: 'Installa in Stremio',
    share: 'Condividi',
    delete: 'Elimina',
    selectListModal: 'A quale lista vuoi aggiungere questo?',
    add: 'Aggiungi',
    cancel: 'Annulla',
    shareTemplate: '{{username}} ti consiglia questa lista "{{listName}}"'
  },
  pt: {
    helloQuestion: 'Olá, qual é o seu nome?',
    yourName: 'Seu nome',
    addonNameQuestion: 'E como eu me chamo?',
    addonNameHelp: 'Este será o nome do addon no Stremio',
    languageQuestion: 'Que idioma você fala?',
    tmdbQuestion: 'Vou precisar da sua chave API TMDB',
    tmdbKeyPlaceholder: 'Chave API TMDB',
    getTmdbKeyText: 'Consiga',
    here: 'AQUI',
    startButton: 'Vamos criar suas listas',
    mainTitleTemplate: 'Certo {{username}}, do que você gostou?',
    yourLists: 'Estas são suas listas',
    createList: 'Criar Nova Lista',
    listName: 'Nome da lista',
    listType: 'Tipo: filme, série...',
    create: 'Criar',
    searchPlaceholder: 'Pesquisar filmes/séries...',
    export: 'Exportar Listas',
    import: 'Importar Listas',
    copyUrl: 'Copiar URL de Instalação',
    install: 'Instalar no Stremio',
    share: 'Compartilhar',
    delete: 'Excluir',
    selectListModal: 'A qual lista você quer adicionar isto?',
    add: 'Adicionar',
    cancel: 'Cancelar',
    shareTemplate: '{{username}} recomenda esta lista "{{listName}}"'
  },
  ru: {
    helloQuestion: 'Привет, как тебя зовут?',
    yourName: 'Твое имя',
    addonNameQuestion: 'А как меня зовут?',
    addonNameHelp: 'Это будет имя аддона в Stremio',
    languageQuestion: 'На каком языке ты говоришь?',
    tmdbQuestion: 'Мне понадобится твой API ключ TMDB',
    tmdbKeyPlaceholder: 'API ключ TMDB',
    getTmdbKeyText: 'Получи его',
    here: 'ЗДЕСЬ',
    startButton: 'Давай создадим твои списки',
    mainTitleTemplate: 'Хорошо {{username}}, что тебе понравилось?',
    yourLists: 'Вот твои списки',
    createList: 'Создать Новый Список',
    listName: 'Название списка',
    listType: 'Тип: фильм, сериал...',
    create: 'Создать',
    searchPlaceholder: 'Искать фильмы/сериалы...',
    export: 'Экспортировать Списки',
    import: 'Импортировать Списки',
    copyUrl: 'Копировать URL Установки',
    install: 'Установить в Stremio',
    share: 'Поделиться',
    delete: 'Удалить',
    selectListModal: 'В какой список добавить это?',
    add: 'Добавить',
    cancel: 'Отменить',
    shareTemplate: '{{username}} рекомендует этот список "{{listName}}"'
  },
  ja: {
    helloQuestion: 'こんにちは、お名前は？',
    yourName: 'あなたの名前',
    addonNameQuestion: '私の名前は？',
    addonNameHelp: 'これがStremioのアドオン名になります',
    languageQuestion: '何語を話しますか？',
    tmdbQuestion: 'TMDB APIキーが必要です',
    tmdbKeyPlaceholder: 'TMDB APIキー',
    getTmdbKeyText: 'こちらで取得',
    here: 'ここ',
    startButton: 'リストを作成しましょう',
    mainTitleTemplate: 'わかりました{{username}}さん、何が好きでしたか？',
    yourLists: 'あなたのリスト',
    createList: '新しいリストを作成',
    listName: 'リスト名',
    listType: 'タイプ：映画、シリーズ...',
    create: '作成',
    searchPlaceholder: '映画/シリーズを検索...',
    export: 'リストをエクスポート',
    import: 'リストをインポート',
    copyUrl: 'インストールURLをコピー',
    install: 'Stremioにインストール',
    share: '共有',
    delete: '削除',
    selectListModal: 'どのリストに追加しますか？',
    add: '追加',
    cancel: 'キャンセル',
    shareTemplate: '{{username}}がこのリスト「{{listName}}」をお勧めします'
  },
  zh: {
    helloQuestion: '你好，你叫什么名字？',
    yourName: '你的名字',
    addonNameQuestion: '我叫什么名字？',
    addonNameHelp: '这将是Stremio中的插件名称',
    languageQuestion: '你说什么语言？',
    tmdbQuestion: '我需要你的TMDB API密钥',
    tmdbKeyPlaceholder: 'TMDB API密钥',
    getTmdbKeyText: '在这里获取',
    here: '这里',
    startButton: '让我们创建你的列表',
    mainTitleTemplate: '好的{{username}}，你喜欢什么？',
    yourLists: '这些是你的列表',
    createList: '创建新列表',
    listName: '列表名称',
    listType: '类型：电影，系列...',
    create: '创建',
    searchPlaceholder: '搜索电影/系列...',
    export: '导出列表',
    import: '导入列表',
    copyUrl: '复制安装URL',
    install: '安装到Stremio',
    share: '分享',
    delete: '删除',
    selectListModal: '你想添加到哪个列表？',
    add: '添加',
    cancel: '取消',
    shareTemplate: '{{username}}推荐这个列表"{{listName}}"'
  }
};

let currentLang = 'es';
let currentUsername = '';
let currentTmdbKey = '';
let currentAddonName = 'CustomLibrary';
let pendingItem = null;

const welcomeUsername = document.getElementById('welcomeUsername');
const addonNameInput = document.getElementById('addonName');
const welcomeTmdbKey = document.getElementById('welcomeTmdbKey');
const startBtn = document.getElementById('startBtn');

function checkWelcomeForm() {
  const hasUsername = welcomeUsername.value.trim().length > 0;
  const hasTmdbKey = welcomeTmdbKey.value.trim().length > 0;
  startBtn.disabled = !(hasUsername && hasTmdbKey);
}

welcomeUsername.addEventListener('input', checkWelcomeForm);
welcomeTmdbKey.addEventListener('input', checkWelcomeForm);

startBtn.addEventListener('click', () => {
  currentUsername = welcomeUsername.value.trim();
  currentTmdbKey = welcomeTmdbKey.value.trim();
  currentAddonName = addonNameInput.value.trim() || 'CustomLibrary';
  
  localStorage.setItem('username', currentUsername);
  localStorage.setItem('tmdbKey', currentTmdbKey);
  localStorage.setItem('addonName', currentAddonName);
  
  const t = translations[currentLang] || translations.es;
  document.getElementById('mainTitle').textContent = t.mainTitleTemplate.replace('{{username}}', currentUsername);
  
  document.getElementById('welcomeScreen').classList.remove('active');
  document.getElementById('mainScreen').classList.add('active');
  
  loadLists(currentUsername);
});

document.getElementById('langSelect').addEventListener('change', (e) => {
  currentLang = e.target.value;
  updateUI();
});

function updateUI() {
  const t = translations[currentLang] || translations.es;
  
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (t[key]) {
      if (key === 'mainTitleTemplate') {
        el.textContent = t[key].replace('{{username}}', currentUsername);
      } else {
        el.textContent = t[key];
      }
    }
  });
  
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.getAttribute('data-i18n-placeholder');
    if (t[key]) el.placeholder = t[key];
  });
}

document.getElementById('newListForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = document.getElementById('listName').value.trim();
  const type = document.getElementById('listType').value.trim();
  
  if (!name || !type) return;
  
  const res = await fetch('/api/lists', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: currentUsername, list: { name, type } })
  });
  
  if (res.ok) {
    loadLists(currentUsername);
    e.target.reset();
  }
});

async function getOptimalId(tmdbId, mediaType) {
  try {
    if (!currentTmdbKey) return `tmdb:${tmdbId}`;
    
    const url = `https://api.themoviedb.org/3/${mediaType === 'tv' ? 'tv' : 'movie'}/${tmdbId}/external_ids?api_key=${currentTmdbKey}`;
    const res = await fetch(url);
    const data = await res.json();
    
    return data.imdb_id || `tmdb:${tmdbId}`;
  } catch (e) {
    return `tmdb:${tmdbId}`;
  }
}

function showListModal(item) {
  pendingItem = item;
  const modal = document.getElementById('listModal');
  modal.classList.add('active');
}

document.getElementById('modalCancelBtn').addEventListener('click', () => {
  document.getElementById('listModal').classList.remove('active');
  pendingItem = null;
});

document.getElementById('modalAddBtn').addEventListener('click', async () => {
  const listId = document.getElementById('modalListSelect').value;
  if (!listId || !pendingItem) return;

  const optimalId = await getOptimalId(pendingItem.tmdbId, pendingItem.mediaType);

  await fetch(`/api/lists/${listId}/items`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ 
      username: currentUsername, 
      item: { 
        tmdbId: pendingItem.tmdbId, 
        imdbId: optimalId, 
        mediaType: pendingItem.mediaType, 
        title: pendingItem.title, 
        poster: pendingItem.poster, 
        overview: pendingItem.overview, 
        rating: pendingItem.rating 
      } 
    })
  });
  
  alert('¡Añadido correctamente!');
  document.getElementById('listModal').classList.remove('active');
  pendingItem = null;
  loadLists(currentUsername);
});

async function loadLists(username) {
  const res = await fetch(`/api/lists?username=${username}`);
  const lists = await res.json();
  
  const t = translations[currentLang] || translations.es;
  const display = document.getElementById('listDisplay');
  display.innerHTML = lists.length === 0 
    ? '<p style="text-align:center; opacity:0.7;">No hay listas creadas aún</p>'
    : lists.map((list, idx) => `
    <div class="list-item" draggable="true" data-id="${list.id}" data-index="${idx}">
      <div class="list-info">
        <strong>${list.name}</strong> <span style="opacity:0.8">(${list.type})</span><br>
        <small>${list.items?.length || 0} elementos</small>
      </div>
      <div class="list-actions">
        <button class="text-btn" onclick="shareList('${list.id}', '${list.name}')">${t.share}</button>
        <div class="arrows">
          <button onclick="moveList('${list.id}', ${idx}, -1)" ${idx === 0 ? 'disabled' : ''}>▲</button>
          <button onclick="moveList('${list.id}', ${idx}, 1)" ${idx === lists.length - 1 ? 'disabled' : ''}>▼</button>
        </div>
        <button class="text-btn" onclick="deleteList('${list.id}')">${t.delete}</button>
      </div>
    </div>
  `).join('');
  
  // Setup drag & drop
  document.querySelectorAll('.list-item').forEach(item => {
    item.addEventListener('dragstart', handleDragStart);
    item.addEventListener('dragover', handleDragOver);
    item.addEventListener('drop', handleDrop);
    item.addEventListener('dragend', handleDragEnd);
  });
  
  const modalListSelect = document.getElementById('modalListSelect');
  modalListSelect.innerHTML = lists.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
}

let draggedElement = null;

function handleDragStart(e) {
  draggedElement = this;
  this.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}

function handleDragOver(e) {
  if (e.preventDefault) e.preventDefault();
  this.classList.add('drag-over');
  e.dataTransfer.dropEffect = 'move';
  return false;
}

function handleDrop(e) {
  if (e.stopPropagation) e.stopPropagation();
  
  if (draggedElement !== this) {
    const fromIndex = parseInt(draggedElement.dataset.index);
    const toIndex = parseInt(this.dataset.index);
    
    moveList(draggedElement.dataset.id, fromIndex, toIndex - fromIndex);
  }
  
  return false;
}

function handleDragEnd() {
  document.querySelectorAll('.list-item').forEach(item => {
    item.classList.remove('dragging', 'drag-over');
  });
}

async function shareList(id, name) {
  const t = translations[currentLang] || translations.es;
  const text = t.shareTemplate.replace('{{username}}', currentUsername).replace('{{listName}}', name);
  const url = `${window.location.origin}/manifest.json?username=${currentUsername}&addonName=${encodeURIComponent(currentAddonName)}`;
  
  if (navigator.share) {
    await navigator.share({ title: name, text, url });
  } else {
    navigator.clipboard.writeText(`${text}\n${url}`);
    alert('¡URL copiada!');
  }
}

async function deleteList(id) {
  if (!confirm('¿Eliminar esta lista?')) return;
  await fetch(`/api/lists/${id}?username=${currentUsername}`, { method: 'DELETE' });
  loadLists(currentUsername);
}

async function moveList(id, currentIndex, direction) {
  const newOrder = currentIndex + direction;
  await fetch(`/api/lists/${id}/reorder`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: currentUsername, newOrder })
  });
  loadLists(currentUsername);
}

document.getElementById('importBtn').addEventListener('click', () => {
  document.getElementById('importFile').click();
});

document.getElementById('importFile').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = async (event) => {
    try {
      const data = JSON.parse(event.target.result);
      const res = await fetch('/api/lists/import', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: currentUsername, lists: data.lists })
      });
      
      if (res.ok) {
        alert('¡Listas importadas correctamente!');
        loadLists(currentUsername);
      }
    } catch (err) {
      alert('Error al importar archivo');
    }
  };
  reader.readAsText(file);
  e.target.value = '';
});

document.getElementById('exportBtn').addEventListener('click', async () => {
  const res = await fetch(`/api/lists?username=${currentUsername}`);
  const lists = await res.json();
  const blob = new Blob([JSON.stringify({ username: currentUsername, lists }, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `customlibrary-${currentUsername}.json`;
  a.click();
});

document.getElementById('copyInstallBtn').addEventListener('click', () => {
  const url = `${window.location.origin}/manifest.json?username=${currentUsername}&addonName=${encodeURIComponent(currentAddonName)}`;
  navigator.clipboard.writeText(url);
  alert('¡URL copiada!');
});

document.getElementById('installBtn').addEventListener('click', () => {
  const url = `stremio://${window.location.host}/manifest.json?username=${currentUsername}&addonName=${encodeURIComponent(currentAddonName)}`;
  window.open(url, '_blank');
});

let searchTimeout;
document.getElementById('searchInput').addEventListener('input', (e) => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(async () => {
    const q = e.target.value.trim();
    if (q.length < 3 || !currentTmdbKey) return;
    
    const langMap = { es: 'es-ES', en: 'en-US', fr: 'fr-FR', de: 'de-DE', it: 'it-IT', pt: 'pt-PT', ru: 'ru-RU', ja: 'ja-JP', zh: 'zh-CN' };
    const res = await fetch(`/api/tmdb/search?q=${q}&key=${currentTmdbKey}&lang=${langMap[currentLang] || 'en-US'}`);
    const data = await res.json();
    
    document.getElementById('searchResults').innerHTML = (data.results || [])
      .filter(item => item.media_type === 'movie' || item.media_type === 'tv')
      .slice(0, 12)
      .map(item => {
        const title = item.title || item.name;
        const mediaType = item.media_type;
        const overview = item.overview || 'No hay sinopsis disponible';
        const rating = item.vote_average ? `⭐ ${item.vote_average.toFixed(1)}` : '';
        
        return `
          <div class="search-item" onclick='showListModal({tmdbId: ${item.id}, mediaType: "${mediaType}", title: "${title.replace(/'/g, "\\'")}", poster: "${item.poster_path || ''}", overview: "${overview.replace(/'/g, "\\'")}", rating: "${rating}"})'>
            <img src="https://image.tmdb.org/t/p/w200${item.poster_path || ''}" alt="${title}" onerror="this.src='image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'80\' height=\'120\'%3E%3Crect fill=\'%23333\' width=\'80\' height=\'120\'/%3E%3C/svg%3E'">
            <div class="search-item-info">
              <strong>${title}</strong>
              <small>${mediaType.toUpperCase()}</small>
              ${rating ? `<div class="rating">${rating}</div>` : ''}
              <div class="overview">${overview}</div>
            </div>
          </div>
        `;
      }).join('');
  }, 600);
});

window.addEventListener('DOMContentLoaded', () => {
  const savedUsername = localStorage.getItem('username');
  const savedKey = localStorage.getItem('tmdbKey');
  const savedAddonName = localStorage.getItem('addonName');
  
  if (savedUsername && savedKey) {
    currentUsername = savedUsername;
    currentTmdbKey = savedKey;
    currentAddonName = savedAddonName || 'CustomLibrary';
    
    const t = translations[currentLang] || translations.es;
    document.getElementById('mainTitle').textContent = t.mainTitleTemplate.replace('{{username}}', currentUsername);
    
    document.getElementById('welcomeScreen').classList.remove('active');
    document.getElementById('mainScreen').classList.add('active');
    loadLists(currentUsername);
  }
  
  updateUI();
});
